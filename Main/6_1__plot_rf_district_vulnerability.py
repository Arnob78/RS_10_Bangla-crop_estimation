import os
import pandas as pd
import geopandas as gpd
import matplotlib.pyplot as plt
import rasterio
from rasterio.plot import show
import numpy as np
from mpl_toolkits.axes_grid1 import make_axes_locatable
from matplotlib.patches import Patch

def add_manual_scalebar(ax, x_frac=0.05, y_frac=0.12, length_km=100, color='black', fontsize=20):
    """Add a manual scalebar to a geographic coordinate plot"""
    xlim = ax.get_xlim()
    ylim = ax.get_ylim()
    
    x_pos = xlim[0] + x_frac * (xlim[1] - xlim[0])
    y_pos = ylim[0] + y_frac * (ylim[1] - ylim[0])
    
    degrees_for_km = length_km / 102.0
    
    ax.plot([x_pos, x_pos + degrees_for_km], 
            [y_pos, y_pos], 
            color=color, linewidth=4, solid_capstyle='butt')
    
    ax.text(x_pos + degrees_for_km/2, 
            y_pos - 0.02,  
            f'{length_km} km', 
            ha='center', va='top',
            fontsize=fontsize,
            fontweight='bold',
            color=color)

def add_north_arrow(ax, x_frac=0.92, y_frac=0.90, length=0.17, color='black', fontsize=22):
    """Add a north arrow to a geographic coordinate plot"""
    xlim = ax.get_xlim()
    ylim = ax.get_ylim()
    
    x_pos = xlim[0] + x_frac * (xlim[1] - xlim[0])
    y_pos = ylim[0] + y_frac * (ylim[1] - ylim[0])
    
    # Draw arrow (bigger with increased linewidth)
    ax.annotate('', 
                xy=(x_pos, y_pos), 
                xytext=(x_pos, y_pos - length),
                arrowprops=dict(arrowstyle='->', color=color, linewidth=3.5, 
                               shrinkA=0, shrinkB=0))
    
    # Add 'N' text (bigger font)
    ax.text(x_pos, y_pos + length * 0.15, 'N', 
            ha='center', va='bottom',
            fontsize=fontsize,
            fontweight='bold',
            color=color)

def main():
    # --- Configuration ---
    try:
        SCRIPT_NAME, _ = os.path.splitext(os.path.basename(__file__))
    except NameError:
        SCRIPT_NAME = "11__classify_and_plot_district_vulnerability"

    PROJECT_ROOT = r"C:\Users\NagaiLab\GC_Project_work\submitted_RS_10_Bangla-crop_estimation"
    
    # --- Inputs ---
    DISTRICT_SCORES_CSV = os.path.join(PROJECT_ROOT, "10__get_rf_location_vulnerability", "district_vulnerability_scores.csv")
    SHAPEFILE_PATH = os.path.join(PROJECT_ROOT, "data", "shapefile", "BGD_adm", "BGD_adm2.shp")
    RASTER_PATH = os.path.join(PROJECT_ROOT, "9__visualize_rf_vulnerability_map", "rf_vulnerability_map_rescaled.tif")
    ORIGINAL_RASTER_PATH = os.path.join(PROJECT_ROOT, "8__generate_rf_vulnerability_map", "rf_crop_vulnerability_map.tif")

    # --- Outputs ---
    OUTPUT_DIR = os.path.join(PROJECT_ROOT, SCRIPT_NAME)
    os.makedirs(OUTPUT_DIR, exist_ok=True)
    OUTPUT_DIAGNOSTIC_PNG = os.path.join(OUTPUT_DIR, "diagnostic_raster_vs_csv.png")

    print("--- Diagnostic Plot: Raster Comparison ---")
    print("NOTE: Creating diagnostic plot with scale bars, grids, and north arrows...")

    # 1. Load Data
    print("Loading data...")
    try:
        districts_gdf = gpd.read_file(SHAPEFILE_PATH)
    except FileNotFoundError as e:
        print(f"FATAL ERROR: Could not find input file. {e}")
        return

    # Check raster statistics
    print(f"\nChecking raster statistics...")
    with rasterio.open(RASTER_PATH) as src:
        data = src.read(1)
        valid_data = data[data != src.nodata]
        print(f"  Rescaled raster range: {valid_data.min():.4f} to {valid_data.max():.4f}")
        print(f"  Raster mean: {valid_data.mean():.4f}")
    
    with rasterio.open(ORIGINAL_RASTER_PATH) as src:
        data = src.read(1)
        valid_data = data[data != src.nodata]
        print(f"  Original raster range: {valid_data.min():.4f} to {valid_data.max():.4f}")
        print(f"  Original raster mean: {valid_data.mean():.4f}")

    # 2. Create diagnostic plot with style from main comparison plot
    print("\nGenerating diagnostic plot...")

    font_factor = 1.8
    fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(24 * 1.2, 12 * 1.2))
    
    # Updated title as requested
    fig.suptitle('Predicted District-Level Crop Vulnerability Map of Bangladesh (2023)\nAnalysis by Random Forest Model', 
                 fontsize=22 * font_factor, weight='bold', y=0.98)

    # --- Panel 1: Original Raster (Z-scores) ---
    ax1.set_title('(A) Original Vulnerability Raster (Z-scores)', fontsize=18 * font_factor)
    
    with rasterio.open(ORIGINAL_RASTER_PATH) as src:
        # Get data for colormap normalization
        data = src.read(1)
        valid_data = data[data != src.nodata]
        vmin, vmax = np.percentile(valid_data, [5, 95])  # Use 5th-95th percentiles to avoid extremes
        
        # Display the original raster with RdBu_r colormap
        img1 = show(src, ax=ax1, cmap='RdBu_r', vmin=vmin, vmax=vmax)
        
        # Overlay district boundaries in red
        districts_gdf.plot(ax=ax1, facecolor='none', edgecolor='red', linewidth=0.7, alpha=0.8)
        
        # Create colorbar for the raster
        divider = make_axes_locatable(ax1)
        cax = divider.append_axes("right", size="5%", pad=0.25)
        cbar = fig.colorbar(img1.get_images()[0], cax=cax, orientation='vertical')
        cbar.set_label('Vulnerability (Z-score)', 
                       fontsize=16 * font_factor, labelpad=15)
        cbar.ax.tick_params(labelsize=14 * font_factor)

    # Add scalebar
    add_manual_scalebar(ax1, length_km=100, fontsize=20, y_frac=0.12)
    
    # Add north arrow (bigger and moved down)
    add_north_arrow(ax1, fontsize=22, y_frac=0.90)

    ax1.set_xlabel("Longitude", fontsize=16 * font_factor)
    ax1.set_ylabel("Latitude", fontsize=16 * font_factor)
    ax1.grid(True, linestyle='--', alpha=0.5)
    ax1.tick_params(axis='both', which='major', labelsize=14 * font_factor)
    ax1.set_aspect('equal', adjustable='box')

    # --- Panel 2: Rescaled Raster (0-1) ---
    ax2.set_title('(B) Rescaled Vulnerability Raster (0-1)', fontsize=18 * font_factor)

    with rasterio.open(RASTER_PATH) as src:
        # Display the rescaled raster (0-1)
        img2 = show(src, ax=ax2, cmap='viridis_r', vmin=0, vmax=1)
        
        # Overlay district boundaries in red
        districts_gdf.plot(ax=ax2, facecolor='none', edgecolor='red', linewidth=0.7, alpha=0.8)
        
        # Create colorbar for the raster
        divider = make_axes_locatable(ax2)
        cax = divider.append_axes("right", size="5%", pad=0.25)
        cbar = fig.colorbar(img2.get_images()[0], cax=cax, orientation='vertical')
        cbar.set_label('Rescaled Vulnerability (0-1)', 
                       fontsize=16 * font_factor, labelpad=15)
        cbar.ax.tick_params(labelsize=14 * font_factor)

    # Add scalebar
    add_manual_scalebar(ax2, length_km=100, fontsize=20, y_frac=0.12)
    
    # Add north arrow (bigger and moved down)
    add_north_arrow(ax2, fontsize=22, y_frac=0.90)

    ax2.set_xlabel("Longitude", fontsize=16 * font_factor)
    ax2.set_ylabel("Latitude", fontsize=16 * font_factor)
    ax2.grid(True, linestyle='--', alpha=0.5)
    ax2.tick_params(axis='both', which='major', labelsize=14 * font_factor)
    ax2.set_aspect('equal', adjustable='box')
    
    # Set consistent axis limits using shapefile bounds
    bounds = districts_gdf.total_bounds
    ax1.set_xlim([bounds[0], bounds[2]])
    ax1.set_ylim([bounds[1], bounds[3]])
    ax2.set_xlim([bounds[0], bounds[2]])
    ax2.set_ylim([bounds[1], bounds[3]])

    # Save the diagnostic plot
    plt.tight_layout(rect=[0, 0.02, 1, 0.95])
    print(f"\nSaving diagnostic plot to: {OUTPUT_DIAGNOSTIC_PNG}")
    plt.savefig(OUTPUT_DIAGNOSTIC_PNG, dpi=300, bbox_inches='tight')
    plt.close()

    # 3. Print summary
    print("\n" + "="*70)
    print("DIAGNOSTIC PLOT INTERPRETATION:")
    print("="*70)
    print("DIAGNOSTIC PLOT (diagnostic_raster_vs_csv.png):")
    print("  (A) Original raster (Z-scores):")
    print("      - Blue = Negative Z-scores (less vulnerable than average)")
    print("      - Red = Positive Z-scores (more vulnerable than average)")
    print("      - White = Near average vulnerability")
    print("      - Red lines = District boundaries")
    print("")
    print("  (B) Rescaled raster (0-1):")
    print("      - Dark blue = Low vulnerability (0)")
    print("      - Bright yellow = High vulnerability (1)")
    print("      - Red lines = District boundaries")
    print("")
    print("  Scale bars: 100 km reference for both maps")
    print("  North arrows: Larger and positioned at 90% height (moved down)")
    print("  Grid lines: Latitude/Longitude grid")
    print("="*70)

    print(f"\n--- Script {SCRIPT_NAME}.py finished successfully. ---")

if __name__ == "__main__":
    main()