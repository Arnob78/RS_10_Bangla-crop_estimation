import os
import rasterio
import geopandas as gpd
import matplotlib.pyplot as plt
import cartopy.crs as ccrs
from rasterio.plot import show
from rasterio.mask import mask
import numpy as np
from mpl_toolkits.axes_grid1 import make_axes_locatable

# --- Configuration ---
try:
    SCRIPT_NAME, _ = os.path.splitext(os.path.basename(__file__))
except NameError:
    SCRIPT_NAME = "9__visualize_rf_vulnerability_map"

def add_manual_scalebar(ax, x_frac=0.05, y_frac=0.12, length_km=100, color='black', fontsize=20):
    """Add a manual scalebar to a geographic coordinate plot"""
    xlim = ax.get_xlim()
    ylim = ax.get_ylim()
    
    x_pos = xlim[0] + x_frac * (xlim[1] - xlim[0])
    y_pos = ylim[0] + y_frac * (ylim[1] - ylim[0])
    
    degrees_for_km = length_km / 102.0
    
    ax.plot([x_pos, x_pos + degrees_for_km], 
            [y_pos, y_pos], 
            color=color, linewidth=4, solid_capstyle='butt')
    
    ax.text(x_pos + degrees_for_km/2, 
            y_pos - 0.02,  
            f'{length_km} km', 
            ha='center', va='top',
            fontsize=fontsize,
            fontweight='bold',
            color=color)

def add_north_arrow(ax, x_frac=0.60, y_frac=0.90, length=0.17, color='black', fontsize=22):
    """Add a north arrow to a geographic coordinate plot"""
    xlim = ax.get_xlim()
    ylim = ax.get_ylim()
    
    x_pos = xlim[0] + x_frac * (xlim[1] - xlim[0])
    y_pos = ylim[0] + y_frac * (ylim[1] - ylim[0])
    
    # Draw arrow (bigger with increased linewidth)
    ax.annotate('', 
                xy=(x_pos, y_pos), 
                xytext=(x_pos, y_pos - length),
                arrowprops=dict(arrowstyle='->', color=color, linewidth=3.5, 
                               shrinkA=0, shrinkB=0))
    
    # Add 'N' text (bigger font)
    ax.text(x_pos, y_pos + length * 0.15, 'N', 
            ha='center', va='bottom',
            fontsize=fontsize,
            fontweight='bold',
            color=color)


# --- Input Files ---
RF_RASTER_PATH = "C:/Users/NagaiLab/GC_Project_work/submitted_RS_10_Bangla-crop_estimation/8__generate_rf_vulnerability_map/rf_crop_vulnerability_map.tif"
SHAPEFILE_PATH = "C:/Users/NagaiLab/GC_Project_work/submitted_RS_10_Bangla-crop_estimation/data/shapefile/bangladesh_boundary.geojson"

# --- Script Execution ---

# 1. Create output directory
print(f"Creating output directory: {SCRIPT_NAME}")
OUTPUT_DIR = os.path.join(os.getcwd(), SCRIPT_NAME)
os.makedirs(OUTPUT_DIR, exist_ok=True)

RESCALED_RASTER_PATH = os.path.join(OUTPUT_DIR, "rf_vulnerability_map_rescaled.tif")
OUTPUT_PLOT_PNG = os.path.join(OUTPUT_DIR, "rf_vulnerability_map_combined_plot.png")

# 2. Rescale the Raster
print(f"Reading original raster for rescaling: {RF_RASTER_PATH}")
with rasterio.open(RF_RASTER_PATH) as src:
    data = src.read(1)
    meta = src.meta.copy()
    nodata = src.nodata

    # Create a masked array to ignore nodata values for min/max calculation
    masked_data = np.ma.masked_equal(data, nodata)

    min_val = masked_data.min()
    max_val = masked_data.max()
    print(f"Original Min for scaling: {min_val:.4f}, Original Max for scaling: {max_val:.4f}")

    # Apply min-max normalization
    rescaled_data = (data - min_val) / (max_val - min_val)
    
    # Preserve nodata values in the rescaled raster
    rescaled_data[data == nodata] = nodata

    # Update metadata for the new rescaled raster
    meta.update(dtype='float32')

    print(f"Saving rescaled raster to: {RESCALED_RASTER_PATH}")
    with rasterio.open(RESCALED_RASTER_PATH, 'w', **meta) as dst:
        dst.write(rescaled_data.astype(rasterio.float32), 1)

# 3. Read the data for plotting
print(f"Reading data for plotting...")
src_original = rasterio.open(RF_RASTER_PATH)
src_rescaled = rasterio.open(RESCALED_RASTER_PATH)
gdf = gpd.read_file(SHAPEFILE_PATH).to_crs(src_original.crs)

# 4. Create the plot
fig, axes = plt.subplots(1, 2, figsize=(20, 12), subplot_kw={'projection': ccrs.PlateCarree()})
fig.suptitle('Crop Vulnerability Maps of Bangladesh (Random Forest Model)', fontsize=20 * 1.8, y=0.95)

# --- Plot Original Vulnerability Map ---
ax0 = axes[0]
ax0.set_title('(a) Predicted Vulnerability', fontsize=16 * 1.8, y=1.05)
out_image_original, out_transform_original = mask(src_original, gdf.geometry, crop=True, filled=False)
img0 = show(out_image_original, ax=ax0, cmap='viridis_r', transform=out_transform_original, vmin=min_val, vmax=max_val)
cbar0 = fig.colorbar(img0.get_images()[0], ax=ax0, orientation='vertical', shrink=0.6)
cbar0.set_label('Predicted Vulnerability (Z-Score)', fontsize=12 * 1.8)
cbar0.ax.tick_params(labelsize=10 * 1.8)
ax0.set_facecolor('white')
gl0 = ax0.gridlines(crs=ccrs.PlateCarree(), draw_labels=True, linewidth=1, color='gray', alpha=0.5, linestyle='--')
gl0.top_labels = False
gl0.right_labels = False
gl0.xlabel_style = {'size': 10 * 1.8}
gl0.ylabel_style = {'size': 10 * 1.8}
ax0.tick_params(labelsize=10 * 1.8)
ax0.add_geometries(gdf.geometry, crs=ccrs.PlateCarree(), facecolor='none', edgecolor='black', linewidth=1.5)

# --- Add statistics text to the first plot ---
# The values are from the vulnerability_statistics.csv file
stats_text = (
    f"Map Statistics (Z-Score):\n"
    f"  Median: {0.7391:.2f}\n"
    f"  5th Pctl: {-0.6293:.2f}\n"
    f"  25th Pctl: {0.3555:.2f}\n"
    f"  75th Pctl: {1.0967:.2f}\n"
    f"  95th Pctl: {1.8130:.2f}"
)

# Place the text in top right in axes coords, without a box
ax0.text(0.97, 0.97, stats_text, transform=ax0.transAxes, fontsize=11 * 1.8,
        verticalalignment='top', horizontalalignment='right')

# Add scalebar and north arrow to first plot
add_manual_scalebar(ax0, length_km=100, fontsize=18, y_frac=0.12)
add_north_arrow(ax0, fontsize=20, y_frac=0.90)

# --- Plot Rescaled Vulnerability Map ---
ax1 = axes[1]
ax1.set_title('(b) Rescaled Vulnerability (0-1)', fontsize=16 * 1.8, y=1.05)
out_image_rescaled, out_transform_rescaled = mask(src_rescaled, gdf.geometry, crop=True, filled=False)
img1 = show(out_image_rescaled, ax=ax1, cmap='viridis_r', transform=out_transform_rescaled, vmin=0, vmax=1)
cbar1 = fig.colorbar(img1.get_images()[0], ax=ax1, orientation='vertical', shrink=0.6)
cbar1.set_label('Rescaled Vulnerability (0-1)', fontsize=12 * 1.8)
cbar1.ax.tick_params(labelsize=10 * 1.8)
ax1.set_facecolor('white')
gl1 = ax1.gridlines(crs=ccrs.PlateCarree(), draw_labels=True, linewidth=1, color='gray', alpha=0.5, linestyle='--')
gl1.top_labels = False
gl1.right_labels = False
gl1.xlabel_style = {'size': 10 * 1.8}
gl1.ylabel_style = {'size': 10 * 1.8}
ax1.tick_params(labelsize=10 * 1.8)
ax1.add_geometries(gdf.geometry, crs=ccrs.PlateCarree(), facecolor='none', edgecolor='black', linewidth=1.5)

# Add scalebar and north arrow to second plot
add_manual_scalebar(ax1, length_km=100, fontsize=18, y_frac=0.12)
add_north_arrow(ax1, fontsize=20, y_frac=0.90)

plt.tight_layout(rect=[0, 0.03, 1, 0.92])

# 5. Save the figure
print(f"Saving combined map to: {OUTPUT_PLOT_PNG}")
plt.savefig(OUTPUT_PLOT_PNG, dpi=300)
plt.close()
src_original.close()
src_rescaled.close()

print(f"\nScript {SCRIPT_NAME}.py finished successfully.")